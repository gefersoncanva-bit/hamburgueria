<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Brasa & Malte - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- SUPABASE SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: {
                            orange: '#f97316',
                            dark: '#0f172a',
                            card: '#1e293b',
                            light: '#fdba74'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #f3f4f6; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Toggle Switch styling if needed */
        .tab-active { border-bottom: 2px solid #f97316; color: white; }
        .tab-inactive { color: #9ca3af; }
    </style>
</head>
<body class="min-h-screen">

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center px-4 bg-brand-dark hidden">
        <div class="bg-brand-card p-8 rounded-3xl shadow-2xl w-full max-w-md border border-gray-800">
            <div class="flex justify-center mb-6">
                <div class="bg-brand-orange/20 p-4 rounded-full">
                    <i data-lucide="lock" class="text-brand-orange w-8 h-8"></i>
                </div>
            </div>
            <h2 class="text-2xl font-black text-white text-center mb-6 italic">ACESSO RESTRITO</h2>
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div class="relative">
                    <input type="password" id="password-input" placeholder="Senha (admin123)" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-4 pr-12 text-white focus:border-brand-orange outline-none">
                    <button type="button" onclick="togglePassword()" class="absolute right-4 top-4 text-gray-500 hover:text-white">
                        <i data-lucide="eye" id="eye-icon" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="remember-me" class="w-4 h-4 rounded border-gray-700 bg-gray-900 text-brand-orange focus:ring-brand-orange">
                    <label for="remember-me" class="text-sm text-gray-400 select-none cursor-pointer">Lembrar-me neste dispositivo</label>
                </div>

                <p id="login-error" class="text-red-500 text-sm font-bold text-center hidden"></p>
                <button type="submit" class="w-full bg-brand-orange hover:bg-orange-600 text-white font-black py-4 rounded-xl uppercase tracking-widest transition">Entrar</button>
            </form>
            <div class="mt-6 text-center">
                <a href="index.html" class="text-gray-500 text-xs hover:text-white">Voltar ao Cardápio</a>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden min-h-screen p-4 md:p-8 bg-brand-dark text-gray-100">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <header class="flex flex-col md:flex-row justify-between items-center bg-brand-card p-6 rounded-3xl gap-6 border border-gray-800 mb-8 shadow-xl">
                <div>
                    <h1 class="text-3xl font-black italic text-brand-orange">PAINEL DE CONTROLE</h1>
                    <p class="text-sm mt-1 font-bold flex items-center gap-2 text-gray-400">
                        Status: <span id="status-text" class="text-green-500">CARREGANDO...</span>
                    </p>
                </div>
                <div class="flex gap-4 w-full md:w-auto">
                    <button onclick="toggleStore()" id="toggle-store-btn" class="flex-1 md:flex-none px-6 py-3 rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg transition duration-300 bg-gray-500 text-white">
                        ...
                    </button>
                    <button onclick="logout()" class="bg-gray-700 hover:bg-gray-600 p-3 rounded-2xl text-white transition">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <!-- Navigation Tabs -->
            <div class="flex gap-6 mb-6 border-b border-gray-800 px-4">
                <button onclick="switchTab('orders')" id="tab-orders" class="pb-3 font-bold uppercase text-sm tracking-wide transition tab-active">
                    <i data-lucide="list" class="w-4 h-4 inline mr-1"></i> Pedidos
                </button>
                <button onclick="switchTab('products')" id="tab-products" class="pb-3 font-bold uppercase text-sm tracking-wide transition tab-inactive hover:text-white">
                    <i data-lucide="utensils" class="w-4 h-4 inline mr-1"></i> Cardápio
                </button>
            </div>

            <!-- VIEW: ORDERS -->
            <div id="view-orders" class="grid grid-cols-1 lg:grid-cols-3 gap-8 fade-in">
                <!-- Order List -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-bold uppercase tracking-tighter border-l-4 border-brand-orange pl-3 flex items-center gap-2">
                            Pedidos Recentes
                        </h2>
                        <button onclick="loadData()" class="text-xs text-gray-500 hover:text-white flex items-center gap-1">
                            <i data-lucide="refresh-cw" class="w-3 h-3"></i> Atualizar
                        </button>
                    </div>

                    <!-- Filters / Actions Toolbar -->
                    <div class="flex flex-wrap gap-3 items-center justify-end bg-gray-900 p-4 rounded-xl border border-gray-800">
                        <div class="flex gap-2 items-center w-full md:w-auto justify-end">
                            <button onclick="printDailyReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-black uppercase flex items-center gap-2 transition-all h-[34px]">
                                <i data-lucide="printer" class="w-4 h-4"></i> Imprimir Dia
                            </button>
                        </div>
                    </div>

                    <div id="orders-container" class="space-y-4">
                        <!-- Orders injected here -->
                        <div class="text-center py-10 text-gray-500">Carregando pedidos...</div>
                    </div>
                </div>

                <!-- Stats Column -->
                <div class="space-y-6">
                    
                    <!-- Daily Summary -->
                    <div class="bg-brand-card p-6 rounded-3xl border border-gray-800 h-fit">
                        <h2 class="text-xl font-bold mb-6 italic uppercase flex items-center gap-2">
                            <i data-lucide="dollar-sign" class="w-5 h-5"></i> Resumo do Dia
                        </h2>
                        <div class="space-y-4">
                            <div class="bg-gray-900 p-5 rounded-2xl border border-gray-800">
                                <span class="text-xs text-gray-500 block uppercase font-bold mb-1">Pedidos Ativos (Hoje)</span>
                                <span id="stat-total-count" class="text-3xl font-black text-white">0</span>
                            </div>
                            <div class="bg-gray-900 p-5 rounded-2xl border border-gray-800">
                                <span class="text-xs text-gray-500 block uppercase font-bold mb-1">Faturamento (Hoje)</span>
                                <span id="stat-total-revenue" class="text-3xl font-black text-green-500">R$ 0.00</span>
                                
                                <div id="daily-payment-breakdown" class="mt-4 pt-3 border-t border-gray-700 space-y-1">
                                    <p class="text-xs text-gray-500 italic">Nenhum pagamento hoje.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Summary -->
                    <div class="bg-brand-card p-6 rounded-3xl border border-gray-800 h-fit">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold italic uppercase flex items-center gap-2 text-brand-orange">
                                <i data-lucide="calendar" class="w-5 h-5"></i> Mensal (Atual)
                            </h2>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-gray-900 p-5 rounded-2xl border border-gray-800">
                                <span class="text-xs text-gray-500 block uppercase font-bold mb-1">Faturamento Mês Atual</span>
                                <span id="month-revenue" class="text-3xl font-black text-green-500">R$ 0.00</span>
                            </div>
                             <div class="bg-gray-900 p-5 rounded-2xl border border-gray-800 flex justify-between items-center">
                                <div>
                                    <span class="text-xs text-gray-500 block uppercase font-bold mb-1">Total Pedidos</span>
                                    <span id="month-count" class="text-2xl font-black text-white">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: PRODUCTS (MENU MANAGEMENT) -->
            <div id="view-products" class="hidden fade-in">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold uppercase tracking-tighter border-l-4 border-brand-orange pl-3">
                        Gerenciar Cardápio
                    </h2>
                    <button onclick="openProductModal()" class="bg-brand-orange hover:bg-orange-600 text-white px-5 py-3 rounded-xl font-bold uppercase text-xs tracking-widest flex items-center gap-2 transition">
                        <i data-lucide="plus" class="w-4 h-4"></i> Novo Produto
                    </button>
                </div>

                <div id="admin-products-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Products injected here -->
                    <div class="text-center py-10 text-gray-500 col-span-full">Carregando produtos...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- PRODUCT MODAL (Create/Edit) -->
    <div id="product-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-brand-card w-full max-w-lg rounded-2xl p-6 shadow-2xl border border-gray-700 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-xl font-black italic text-white uppercase">Novo Produto</h3>
                <button onclick="closeProductModal()" class="bg-gray-800 p-2 rounded-full text-gray-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>

            <form onsubmit="handleProductSubmit(event)" class="space-y-4">
                <input type="hidden" id="prod-id">
                
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Nome do Produto</label>
                    <input type="text" id="prod-name" required class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-brand-orange outline-none">
                </div>

                <div class="flex gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Preço (R$)</label>
                        <input type="number" step="0.01" id="prod-price" required class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-brand-orange outline-none">
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Categoria</label>
                        <select id="prod-category" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-brand-orange outline-none">
                            <!-- Populated by JS -->
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Descrição</label>
                    <textarea id="prod-desc" rows="3" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-brand-orange outline-none resize-none"></textarea>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">URL da Imagem</label>
                    <input type="url" id="prod-image" placeholder="https://..." required class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-brand-orange outline-none">
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Opções (Separar por vírgula)</label>
                    <input type="text" id="prod-options" placeholder="Ex: Coca-Cola, Guaraná, Fanta" class="w-full bg-gray-900 border border-gray-700 rounded-xl p-3 text-white focus:border-brand-orange outline-none">
                    <p class="text-[10px] text-gray-500 mt-1">Deixe em branco se não houver opções.</p>
                </div>

                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-4 rounded-xl uppercase tracking-widest transition mt-4">
                    Salvar Produto
                </button>
            </form>
        </div>
    </div>

    <script>
        /* 
        =====================================================
        INSTRUÇÕES PARA SUPABASE (SQL EDITOR)
        Rode esses comandos no SQL Editor do Supabase para criar as tabelas:

        create table products (
            id bigint generated by default as identity primary key,
            name text,
            price float,
            description text,
            image text,
            category text,
            options text[]
        );

        create table orders (
            id bigint generated by default as identity primary key,
            customer_name text,
            customer_phone text,
            total float,
            status text default 'Pendente',
            items jsonb,
            payment_method text,
            change_amount text,
            delivery_type text,
            address text,
            discount float,
            created_at timestamp with time zone default timezone('utc'::text, now())
        );

        create table settings (
            key text primary key,
            value boolean
        );

        insert into settings (key, value) values ('store_open', true);
        =====================================================
        */

        const SUPABASE_URL = 'https://ckcajwsmqnducxrxonfo.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_n2PHls5ekhYuMqOnKsC5wQ_osqjDuC-';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const AUTH_KEY = 'brasa_admin_auth';
        let orders = [];
        let products = [];
        let isStoreOpen = true;

        const CATEGORIES = [
            { id: 'Hamburguers', label: 'Hamburguers' },
            { id: 'Combos', label: 'Combos' },
            { id: 'Acompanhamentos', label: 'Acomp.' },
            { id: 'Refrigerantes', label: 'Bebidas' },
            { id: 'Sucos', label: 'Sucos' },
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // Auth Check
            const isAuth = sessionStorage.getItem(AUTH_KEY) === 'true' || localStorage.getItem(AUTH_KEY) === 'true';

            if (isAuth) {
                showDashboard();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
            lucide.createIcons();
            populateCategorySelect();
        });

        function handleLogin(e) {
            e.preventDefault();
            const pass = document.getElementById('password-input').value;
            const remember = document.getElementById('remember-me').checked;

            if (pass === 'admin123') {
                if (remember) {
                    localStorage.setItem(AUTH_KEY, 'true');
                } else {
                    sessionStorage.setItem(AUTH_KEY, 'true');
                }
                showDashboard();
            } else {
                const err = document.getElementById('login-error');
                err.innerText = "Senha incorreta";
                err.classList.remove('hidden');
            }
        }

        function togglePassword() {
            const input = document.getElementById('password-input');
            const icon = document.getElementById('eye-icon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.setAttribute('data-lucide', 'eye-off');
            } else {
                input.type = 'password';
                icon.setAttribute('data-lucide', 'eye');
            }
            lucide.createIcons();
        }

        function logout() {
            sessionStorage.removeItem(AUTH_KEY);
            localStorage.removeItem(AUTH_KEY);
            location.reload();
        }

        function showDashboard() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Initial Load
            loadData();
            loadProducts();
            
            // Realtime Listeners
            supabase.channel('custom-all-channel')
            .on(
                'postgres_changes',
                { event: '*', schema: 'public', table: 'orders' },
                (payload) => {
                    console.log('Realtime update:', payload);
                    loadData(); // Reload orders on any change
                }
            )
            .subscribe();

            supabase.channel('settings-channel')
            .on(
                'postgres_changes',
                { event: 'UPDATE', schema: 'public', table: 'settings' },
                (payload) => {
                    if(payload.new.key === 'store_open') {
                        isStoreOpen = payload.new.value;
                        updateStoreStatusUI();
                    }
                }
            )
            .subscribe();
        }

        function switchTab(tab) {
            const viewOrders = document.getElementById('view-orders');
            const viewProducts = document.getElementById('view-products');
            const tabOrders = document.getElementById('tab-orders');
            const tabProducts = document.getElementById('tab-products');

            if (tab === 'orders') {
                viewOrders.classList.remove('hidden');
                viewProducts.classList.add('hidden');
                tabOrders.classList.add('tab-active');
                tabOrders.classList.remove('tab-inactive');
                tabProducts.classList.remove('tab-active');
                tabProducts.classList.add('tab-inactive');
            } else {
                viewOrders.classList.add('hidden');
                viewProducts.classList.remove('hidden');
                tabProducts.classList.add('tab-active');
                tabProducts.classList.remove('tab-inactive');
                tabOrders.classList.remove('tab-active');
                tabOrders.classList.add('tab-inactive');
                loadProducts();
            }
        }

        // --- DATA LOGIC ---
        async function loadData() {
            try {
                // Fetch Orders
                const { data: ordersData, error: ordersError } = await supabase
                    .from('orders')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (ordersError) throw ordersError;
                orders = ordersData || [];

                // Fetch Store Status
                const { data: settingsData, error: settingsError } = await supabase
                    .from('settings')
                    .select('value')
                    .eq('key', 'store_open')
                    .single();

                if (!settingsError && settingsData) {
                    isStoreOpen = settingsData.value;
                }

                updateStoreStatusUI();
                renderOrders();
                renderDailyStats();
                renderMonthlyStats();

            } catch (error) {
                console.error("Erro ao carregar dados:", error);
            }
        }

        // --- PRODUCTS CRUD LOGIC ---
        async function loadProducts() {
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('name');
                
                if (error) throw error;
                products = data || [];
                renderAdminProducts();
            } catch (error) {
                console.error("Erro ao carregar produtos:", error);
            }
        }

        function renderAdminProducts() {
            const container = document.getElementById('admin-products-list');
            if(products.length === 0) {
                 container.innerHTML = '<div class="text-center py-10 text-gray-500 col-span-full">Nenhum produto cadastrado.</div>';
                 return;
            }

            container.innerHTML = products.map(p => `
                <div class="bg-brand-card p-4 rounded-xl border border-gray-800 flex gap-4 items-center">
                    <img src="${p.image}" class="w-20 h-20 rounded-lg object-cover bg-gray-900">
                    <div class="flex-1 overflow-hidden">
                        <span class="text-[10px] uppercase text-brand-orange font-bold">${p.category}</span>
                        <h3 class="font-bold text-white truncate">${p.name}</h3>
                        <p class="text-sm text-gray-400">R$ ${p.price.toFixed(2)}</p>
                    </div>
                    <div class="flex flex-col gap-2">
                        <button onclick="editProduct(${p.id})" class="bg-blue-500/20 hover:bg-blue-500/40 text-blue-500 p-2 rounded-lg transition">
                            <i data-lucide="edit-2" class="w-4 h-4"></i>
                        </button>
                        <button onclick="deleteProduct(${p.id})" class="bg-red-500/20 hover:bg-red-500/40 text-red-500 p-2 rounded-lg transition">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function populateCategorySelect() {
            const select = document.getElementById('prod-category');
            select.innerHTML = CATEGORIES.map(c => `<option value="${c.id}">${c.label}</option>`).join('');
        }

        function openProductModal() {
            document.getElementById('product-modal').classList.remove('hidden');
            document.getElementById('modal-title').innerText = "Novo Produto";
            // Reset form
            document.getElementById('prod-id').value = '';
            document.getElementById('prod-name').value = '';
            document.getElementById('prod-price').value = '';
            document.getElementById('prod-desc').value = '';
            document.getElementById('prod-image').value = '';
            document.getElementById('prod-options').value = '';
            document.getElementById('prod-category').value = CATEGORIES[0].id;
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.add('hidden');
        }

        function editProduct(id) {
            const product = products.find(p => p.id == id);
            if (!product) return;

            document.getElementById('modal-title').innerText = "Editar Produto";
            document.getElementById('prod-id').value = product.id;
            document.getElementById('prod-name').value = product.name;
            document.getElementById('prod-price').value = product.price;
            document.getElementById('prod-desc').value = product.description;
            document.getElementById('prod-image').value = product.image;
            document.getElementById('prod-category').value = product.category;
            document.getElementById('prod-options').value = product.options ? product.options.join(', ') : '';

            document.getElementById('product-modal').classList.remove('hidden');
        }

        async function deleteProduct(id) {
            if (confirm("Tem certeza que deseja remover este produto?")) {
                const { error } = await supabase.from('products').delete().eq('id', id);
                if(error) alert("Erro ao deletar");
                else loadProducts();
            }
        }

        async function handleProductSubmit(e) {
            e.preventDefault();
            
            const idInput = document.getElementById('prod-id').value;
            const name = document.getElementById('prod-name').value;
            const price = parseFloat(document.getElementById('prod-price').value);
            const description = document.getElementById('prod-desc').value;
            const image = document.getElementById('prod-image').value;
            const category = document.getElementById('prod-category').value;
            const optionsStr = document.getElementById('prod-options').value;
            
            const options = optionsStr.trim() ? optionsStr.split(',').map(s => s.trim()) : [];

            const productData = { name, price, description, image, category, options };

            try {
                if (idInput) {
                    // Update
                    const { error } = await supabase.from('products').update(productData).eq('id', idInput);
                    if(error) throw error;
                } else {
                    // Create
                    const { error } = await supabase.from('products').insert([productData]);
                    if(error) throw error;
                }
                loadProducts();
                closeProductModal();
            } catch(error) {
                alert("Erro ao salvar produto: " + error.message);
            }
        }


        // --- GENERIC ADMIN LOGIC ---
        async function toggleStore() {
            const newState = !isStoreOpen;
            const { error } = await supabase
                .from('settings')
                .upsert({ key: 'store_open', value: newState });
            
            if(!error) {
                isStoreOpen = newState;
                updateStoreStatusUI();
            } else {
                alert("Erro ao alterar status da loja");
            }
        }

        function updateStoreStatusUI() {
            const txt = document.getElementById('status-text');
            const btn = document.getElementById('toggle-store-btn');
            
            if(isStoreOpen) {
                txt.innerText = "ABERTO PARA PEDIDOS";
                txt.className = "text-green-500";
                btn.innerText = "FECHAR LOJA";
                btn.className = "flex-1 md:flex-none px-6 py-3 rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg transition duration-300 bg-red-500 hover:bg-red-600 text-white";
            } else {
                txt.innerText = "FECHADO";
                txt.className = "text-red-500";
                btn.innerText = "ABRIR LOJA";
                btn.className = "flex-1 md:flex-none px-6 py-3 rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg transition duration-300 bg-green-500 hover:bg-green-600 text-white";
            }
        }

        async function updateStatus(orderId, newStatus) {
            const { error } = await supabase.from('orders').update({ status: newStatus }).eq('id', orderId);
            if(error) alert("Erro ao atualizar status");
            // loadData triggered by Realtime
        }

        function printDailyReport() {
            const d = new Date();
            const todayStr = d.toLocaleDateString('pt-BR');
            
            const dailyOrders = orders.filter(o => {
                const oDate = new Date(o.created_at).toLocaleDateString('pt-BR');
                return oDate === todayStr;
            });

            if (dailyOrders.length === 0) return alert("Sem pedidos hoje para imprimir.");

            let totalRevenue = 0;
            const payments = { 'Pix': 0, 'Cartão': 0, 'Dinheiro': 0 };

            dailyOrders.forEach(o => {
                if(o.status !== 'Cancelado') {
                    totalRevenue += o.total;
                    const method = o.payment_method || 'Outros';
                    if(!payments[method]) payments[method] = 0;
                    payments[method] += o.total;
                }
            });

            const printWindow = window.open('', '', 'width=800,height=600');
            if (!printWindow) return alert("Habilite pop-ups para imprimir.");

            printWindow.document.write(`
                <html>
                <head>
                    <title>Extrato Diário - Brasa & Malte</title>
                    <style>
                        @page { margin: 0; size: auto; }
                        body { 
                            font-family: 'Courier New', Courier, monospace; 
                            padding: 10px; 
                            color: #000; 
                            max-width: 80mm; 
                            margin: 0 auto;
                        }
                        h1 { text-align: center; font-size: 18px; margin-bottom: 5px; text-transform: uppercase; }
                        .subtitle { text-align: center; font-size: 11px; margin-bottom: 15px; border-bottom: 1px dashed #000; padding-bottom: 8px; }
                        .summary { margin-bottom: 15px; font-size: 12px; font-weight: bold; border-bottom: 1px dashed #000; padding-bottom: 8px; }
                        .summary div { display: flex; justify-content: space-between; margin-bottom: 4px; }
                        table { width: 100%; border-collapse: collapse; font-size: 11px; }
                        th { text-align: left; border-bottom: 1px solid #000; padding: 4px 0; font-size: 10px; }
                        td { padding: 4px 0; border-bottom: 1px dotted #ccc; vertical-align: top; }
                        .right { text-align: right; }
                        .status-cancelado { text-decoration: line-through; color: #555; }
                        @media print {
                            body { margin: 0.5cm; width: 100%; max-width: 100%; }
                        }
                    </style>
                </head>
                <body>
                    <h1>Brasa & Malte</h1>
                    <div class="subtitle">
                        Extrato de Vendas - ${todayStr}<br>
                        Emitido em: ${new Date().toLocaleTimeString('pt-BR')}
                    </div>

                    <div class="summary">
                        <div><span>PEDIDOS TOTAIS:</span> <span>${dailyOrders.length}</span></div>
                        <div><span>FATURAMENTO:</span> <span>R$ ${totalRevenue.toFixed(2)}</span></div>
                        <br>
                        ${Object.keys(payments).map(k => `<div><span>${k}:</span> <span>R$ ${payments[k].toFixed(2)}</span></div>`).join('')}
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th style="width: 15%">Hora</th>
                                <th style="width: 55%">Info</th>
                                <th class="right" style="width: 30%">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${dailyOrders.map(o => `
                                <tr class="${o.status === 'Cancelado' ? 'status-cancelado' : ''}">
                                    <td>${new Date(o.created_at).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</td>
                                    <td>
                                        <b>#${o.id}</b> ${o.customer_name}<br>
                                        <span style="font-size:9px">${o.payment_method}</span>
                                    </td>
                                    <td class="right">R$ ${o.total.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 25px; text-align: center; font-size: 10px;">
                        *** Fim do Extrato ***
                    </div>

                    <script>
                        window.onload = function() { window.print(); }
                    <\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        function printOrder(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const printWindow = window.open('', '', 'width=600,height=800');
            if (!printWindow) return alert("Habilite pop-ups para imprimir.");

            const itemsHtml = order.items.map(item => `
                <div style="border-bottom: 1px dashed #ccc; padding: 5px 0;">
                    <div style="font-weight: bold;">${item.quantity}x ${item.name}</div>
                    ${item.details ? `<div style="font-size: 10px; color: #555;">${item.details}</div>` : ''}
                    <div style="text-align: right;">R$ ${(item.price * item.quantity).toFixed(2)}</div>
                </div>
            `).join('');

            printWindow.document.write(`
                <html>
                    <head>
                        <title>Pedido #${order.id} - Brasa & Malte</title>
                        <style>
                            @page { margin: 0; size: auto; }
                            body { font-family: 'Courier New', Courier, monospace; padding: 10px; max-width: 80mm; margin: 0 auto; color: #000; }
                            .header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 8px; }
                            h2 { margin: 0 0 5px 0; font-size: 18px; text-transform: uppercase; }
                            h3 { margin: 5px 0; font-size: 14px; }
                            .info { margin-bottom: 15px; font-size: 12px; line-height: 1.4; }
                            .items { font-size: 12px; margin-bottom: 15px; }
                            .total { margin-top: 10px; border-top: 2px solid #000; padding-top: 8px; text-align: right; font-size: 16px; font-weight: bold; }
                            @media print {
                                body { margin: 0.2cm; width: 100%; max-width: 100%; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h2>Brasa & Malte</h2>
                            <h3>PEDIDO #${order.id}</h3>
                            <div style="font-size: 10px;">${new Date(order.created_at).toLocaleString('pt-BR')}</div>
                        </div>
                        <div class="info">
                            <b>Cliente:</b> ${order.customer_name}<br>
                            <b>Tel:</b> ${order.customer_phone}<br>
                            <b>Tipo:</b> ${order.delivery_type === 'delivery' ? 'ENTREGA' : 'RETIRADA'}<br>
                            ${order.address ? `<b>Endereço:</b> ${order.address}<br>` : ''}
                            <div style="margin-top: 5px;">
                                <b>Pagamento:</b> ${order.payment_method}<br>
                                ${order.change_amount ? `Troco para: ${order.change_amount}` : ''}
                            </div>
                        </div>
                        <div class="items">
                            ${itemsHtml}
                        </div>
                        ${order.discount > 0 ? `<div style="text-align: right; font-size: 11px;">Desconto: - R$ ${order.discount.toFixed(2)}</div>` : ''}
                        ${order.delivery_type === 'delivery' ? `<div style="text-align: right; font-size: 11px;">Taxa Entrega: R$ 7.00</div>` : ''}
                        <div class="total">
                            TOTAL: R$ ${order.total.toFixed(2)}
                        </div>
                        <div style="text-align: center; margin-top: 20px; font-size: 10px;">
                            Obrigado pela preferência!
                        </div>
                        <script>
                            window.onload = function() { window.print(); }
                        <\/script>
                    </body>
                </html>
            `);
            printWindow.document.close();
        }

        function renderOrders() {
            const container = document.getElementById('orders-container');
            const today = new Date().toLocaleDateString('pt-BR');
            
            // Filter active orders for stats
            const activeTodayOrders = orders.filter(o => {
                const isToday = new Date(o.created_at).toLocaleDateString('pt-BR') === today;
                return isToday && o.status !== 'Cancelado';
            });

            // Calculate Payment breakdown
            const dailyBreakdown = { 'Pix': 0, 'Cartão': 0, 'Dinheiro': 0 };
            activeTodayOrders.forEach(o => {
                const m = o.payment_method || 'Outros';
                if (dailyBreakdown[m] === undefined) dailyBreakdown[m] = 0;
                dailyBreakdown[m] += o.total;
            });

            const dailyBreakdownContainer = document.getElementById('daily-payment-breakdown');
            if (activeTodayOrders.length === 0) {
                dailyBreakdownContainer.innerHTML = '<p class="text-xs text-gray-500 italic">Nenhum pagamento hoje.</p>';
            } else {
                dailyBreakdownContainer.innerHTML = Object.keys(dailyBreakdown).map(m => {
                    const v = dailyBreakdown[m];
                    if (v === 0) return '';
                    return `
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-gray-400">${m}</span>
                            <span class="font-bold text-gray-200">R$ ${v.toFixed(2)}</span>
                        </div>
                    `;
                }).join('');
            }

            if(orders.length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic text-center py-8">Nenhum pedido encontrado.</p>';
                return;
            }

            container.innerHTML = orders.map(order => `
                <div class="bg-brand-card p-6 rounded-2xl border border-gray-800 shadow-lg fade-in">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-[10px] bg-gray-800 text-gray-400 px-2 py-1 rounded uppercase font-bold tracking-widest border border-gray-700">
                                ${new Date(order.created_at).toLocaleString('pt-BR')}
                            </span>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="bg-brand-orange text-white text-xs font-black px-2 py-0.5 rounded">#${order.id}</span>
                                <h3 class="text-lg font-black text-white">${order.customer_name}</h3>
                            </div>
                            <p class="text-brand-orange font-bold text-sm flex items-center gap-2 mt-1">
                                ${order.customer_phone} 
                                <span class="text-gray-500 text-xs font-normal">(${order.delivery_type === 'delivery' ? 'Entrega' : 'Retirada'})</span>
                            </p>
                            ${order.address ? `<p class="text-xs text-gray-400 mt-1 max-w-md">${order.address}</p>` : ''}
                            <p class="text-xs text-green-400 mt-1">Pgto: ${order.payment_method} ${order.change_amount ? `(Troco para ${order.change_amount})` : ''}</p>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase border 
                                ${order.status === 'Pendente' ? 'bg-yellow-500/20 text-yellow-500 border-yellow-500/50' : 
                                  order.status === 'Entregue' ? 'bg-green-500/20 text-green-500 border-green-500/50' :
                                  order.status === 'Cancelado' ? 'bg-red-500/20 text-red-500 border-red-500/50' : 
                                  'bg-blue-500/20 text-blue-500 border-blue-500/50'}">
                                ${order.status}
                            </span>
                            <span class="text-xl font-black text-white italic ${order.status === 'Cancelado' ? 'line-through text-red-500' : ''}">R$ ${order.total.toFixed(2)}</span>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-4 bg-black/20 p-3 rounded-xl border border-white/5">
                        ${order.items.map(item => `
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-400">
                                    <b class="text-brand-orange">${item.quantity}x</b> ${item.name} 
                                    ${item.details ? `<span class="text-xs block text-gray-500 ml-4">${item.details}</span>` : ''}
                                </span>
                                <span class="text-gray-300 font-medium">R$ ${(item.price * item.quantity).toFixed(2)}</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="flex gap-2">
                        <select 
                            onchange="updateStatus(${order.id}, this.value)" 
                            class="flex-1 bg-gray-900 border border-gray-700 rounded-lg p-2 text-xs font-bold text-white outline-none focus:border-brand-orange"
                        >
                            <option value="Pendente" ${order.status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                            <option value="Preparando" ${order.status === 'Preparando' ? 'selected' : ''}>Preparando</option>
                            <option value="Saiu para Entrega" ${order.status === 'Saiu para Entrega' ? 'selected' : ''}>Saiu para Entrega</option>
                            <option value="Entregue" ${order.status === 'Entregue' ? 'selected' : ''}>Entregue</option>
                            <option value="Cancelado" ${order.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                        </select>
                        <button onclick="printOrder(${order.id})" class="bg-blue-500/10 hover:bg-blue-500/20 text-blue-500 p-2 rounded-lg border border-blue-500/20 transition">
                            <i data-lucide="printer" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function renderDailyStats() {
            const today = new Date().toLocaleDateString('pt-BR');
            const activeTodayOrders = orders.filter(o => {
                const isToday = new Date(o.created_at).toLocaleDateString('pt-BR') === today;
                return isToday && o.status !== 'Cancelado';
            });
            const todayRevenue = activeTodayOrders.reduce((acc, o) => acc + o.total, 0);

            document.getElementById('stat-total-count').innerText = activeTodayOrders.length;
            document.getElementById('stat-total-revenue').innerText = `R$ ${todayRevenue.toFixed(2)}`;
        }

        function renderMonthlyStats() {
            const today = new Date();
            const currentMonthKey = `${today.getMonth() + 1}/${today.getFullYear()}`;
            
            const monthlyOrders = orders.filter(o => {
                const d = new Date(o.created_at);
                const k = `${d.getMonth() + 1}/${d.getFullYear()}`;
                return k === currentMonthKey && o.status !== 'Cancelado';
            });

            const revenue = monthlyOrders.reduce((acc, o) => acc + o.total, 0);

            document.getElementById('month-revenue').innerText = `R$ ${revenue.toFixed(2)}`;
            document.getElementById('month-count').innerText = monthlyOrders.length;
        }
    </script>
</body>
</html>